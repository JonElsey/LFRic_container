Bootstrap: docker
From: centos:7
IncludeCmd: yes

%setup
      cp files/container_usr.tgz ${SINGULARITY_ROOTFS}
      cp files/setup ${SINGULARITY_ROOTFS}


%post
      yum update -y
      yum install epel-release -y
      yum install -y make cmake git python-devel gcc
      yum install -y environment-modules tclx
      yum install -y centos-release-scl
      yum install -y devtoolset-7-gcc devtoolset-7-gcc-c++ automake zlib-static
      yum install -y wget subversion perl-URI udunits2-devel

#Python 3
      yum install -y python36 python36-devel 
      python3 -m pip install --no-cache-dir  --upgrade pip
      python3 -m pip install --upgrade setuptools
      python3 -m pip install Jinja2
      python3 -m pip install PSyclone
      mkdir -p /container/usr/bin
      ln -s /usr/bin/python3 /container/usr/bin/python

      cd /container
      tar xvf /container_usr.tgz
      rm /container_usr.tgz
      cp /setup /container
      rm -f /setup


#Move devtoolset
      mkdir -p /container/opt
      cp -a /opt/rh /container/opt
      sed 's+/opt/rh+/container/opt/rh+g' /container/opt/rh/devtoolset-7/enable > /container/opt/rh/devtoolset-7/enable.new
      cp /container/opt/rh/devtoolset-7/enable.new /container/opt/rh/devtoolset-7/enable
      rm -fr /opt/rh
