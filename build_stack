
. /container/opt/rh/devtoolset-7/enable


BUILD_DIR=/tmp/build
BASE_DIR=$PWD
mkdir -p $BASE_DIR
mkdir -p $BUILD_DIR
cp files/mk_arch_files_intel.sh $BUILD_DIR


NCORES=8

export INSTALL_DIR=$BASE_DIR/usr
export NETCDF_DIR=$BASE_DIR/usr
export CPPFLAGS=-I$INSTALL_DIR/include
export FFLAGS=-I$INSTALL_DIR/include
export LDFLAGS=-L$INSTALL_DIR/lib 
export PATH=$INSTALL_DIR/bin:$PATH
export LD_LIBRARY_PATH=$INSTALL_DIR/lib:$LD_LIBRARY_PATH

HDF5=1.8.16
NETCDF4=4.3.3.1
NETCDF_FORTRAN=4.4.2
NETCDF_CXX=4.2
YAXT=0.8.1
PFUNIT=3.2.9



#mpich
cd $BUILD_DIR
wget http://www.mpich.org/static/downloads/3.2/mpich-3.2.tar.gz
tar -xzf mpich-3.2.tar.gz
cd mpich-3.2
FC=ifort CC=gcc ./configure --prefix=$INSTALL_DIR --enable-fortran=all --enable-cxx --enable-threads=multiple --enable-shared --enable-romio
make -j$NCORES
make install



#hdf5
cd $BUILD_DIR
wget http://www.hdfgroup.org/ftp/HDF5/prev-releases/hdf5-1.8/hdf5-$HDF5/src/hdf5-$HDF5.tar.gz
tar -xzf hdf5-$HDF5.tar.gz
cd $BUILD_DIR/hdf5-$HDF5
CC=mpicc FC=mpif90 ./configure --prefix=$INSTALL_DIR --disable-shared --enable-static --enable-fortran --enable-fortran2003 --enable-parallel --enable-static-exec --with-szlib=no
make -j$NCORES
make install

#netcdf
cd $BUILD_DIR
wget ftp://ftp.unidata.ucar.edu/pub/netcdf/netcdf-$NETCDF4.tar.gz
tar -xzf netcdf-$NETCDF4.tar.gz
cd $BUILD_DIR/netcdf-$NETCDF4
CC=mpicc CXX=mpicxx FF=mpif90 FC=mpif90 ./configure --prefix=$INSTALL_DIR --disable-shared --disable-dap
make -j$NCORES
make install

#netcdf-fortran
cd $BUILD_DIR
wget ftp://ftp.unidata.ucar.edu/pub/netcdf/netcdf-fortran-$NETCDF_FORTRAN.tar.gz
tar -xzf netcdf-fortran-$NETCDF_FORTRAN.tar.gz
cd $BUILD_DIR/netcdf-fortran-$NETCDF_FORTRAN
CC=mpicc CXX=mpicxx FF=mpif90 FC=mpif90 ./configure --prefix=$INSTALL_DIR --disable-shared
make -j$NCORES
make install

#netcdf-cxx
cd $BUILD_DIR
wget ftp://ftp.unidata.ucar.edu/pub/netcdf/netcdf-cxx-NETCDF_CXX.tar.gz
tar -xzf netcdf-cxx-NETCDF_CXX.tar.gz
cd $BUILD_DIR/netcdf-cxx-NETCDF_CXX
CC=mpicc CXX=mpicxx FF=mpif90 FC=mpif90 ./configure --prefix=$INSTALL_DIR --disable-shared
make -j$NCORES
make install

export LIBS='-lnetcdff -lnetcdf -lhdf5_hl -lhdf5'

#yaxt
cd $BUILD_DIR
wget https://www.dkrz.de/redmine/attachments/download/488/yaxt-$YAXT.tar.gz
tar -xzf yaxt-$YAXT.tar.gz
cd $BUILD_DIR/yaxt-$YAXT
./configure --prefix=$INSTALL_DIR --with-idxtype=long CC=mpicc FC=mpif90 FPP="mpif90 -E" --disable-shared
make -j$NCORES
make install


#XIOS
#use mk_arch_files.sh 
cd $BUILD_DIR
export NETCDF_DIR=$INSTALL_DIR
export HDF5_DIR=$INSTALL_DIR 
svn co http://forge.ipsl.jussieu.fr/ioserver/svn/XIOS/trunk XIOS 
cd $BUILD_DIR/XIOS
../mk_arch_files_intel.sh INTEL_MPI
mv *INTEL_MPI* arch
./make_xios --full --arch INTEL_MPI --job $NCORES
cp -r lib $INSTALL_DIR
cp inc/* $INSTALL_DIR/include
cp bin/* $INSTALL_DIR/bin

#pFUnit
cd $BUILD_DIR
wget https://sourceforge.net/projects/pfunit/files/latest/download/pFUnit-$PFUNIT.tgz
tar -xzf pFUnit-$PFUNIT.tgz
cd pFUnit-$PFUNIT
export F90_VENDOR=Intel
export F90=ifort
export MPIF90=mpif90
make -j $NCORES
make install

cd $BASE_DIR
tar zcvf $BASE_DIR/files/container_usr.tgz usr
